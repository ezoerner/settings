#!/bin/sh

set -e

# echo "WARNING YOU ARE USING dev-ExaTMS"

if [ -z "$1" ]; then
    RESOURCES="${HOME}/Developer/workspace/ExaTMS/resources"
else
    RESOURCES="${HOME}/Developer/workspace/${1}-ExaTMS/resources"
fi

if [ ! -d "${RESOURCES}" ]; then
    echo "Does not exist: ${RESOURCES}"
    exit 1
fi

#DBNAME=tripshot_test
DBNAME=tripshot

psql="psql -v ON_ERROR_STOP=1 --no-password -t -q"

cqlsh="${HOME}/Developer/apache-cassandra-2.1.17/bin/cqsh"

$cqlsh -e "drop keyspace if exists \"$DBNAME\";"
$cqlsh -e "create keyspace \"$DBNAME\" with replication = { 'class' : 'SimpleStrategy', 'replication_factor': 1 };"
$cqlsh -k $DBNAME < "$RESOURCES/model.cql"

$psql -d postgres -c "DROP DATABASE IF EXISTS $DBNAME"
$psql -d postgres -c "CREATE DATABASE $DBNAME"
$psql -d $DBNAME -c 'CREATE EXTENSION IF NOT EXISTS "hstore"; CREATE EXTENSION IF NOT EXISTS "uuid-ossp"; create extension if not exists "citext";'

PGPASSWORD=trip4tw $psql -U tripshot -d $DBNAME < "$RESOURCES/model.sql"

echo "Loaded from: $RESOURCES"
